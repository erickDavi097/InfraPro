<!DOCTYPE html>
<html>

<head>
    <title>Perfil do Usuário</title>
    <link rel="stylesheet" href="css/perfil.css" />
    <link rel="shortcut icon" href="./assets/icon/logo.png" type="image/x-icon">
</head>

<body>
    <nav class="sidebar">
        <h2>InfraPro</h2>
        <a href="#">Dashboard</a>
        <a href="#">Perfil</a>
        <a href="#">Usuários</a>
        <a href="#">Configurações</a>
    </nav>

    <main class="content">

        <div class="profile-card">
            <div>
                <label for="upload-photo" class="profile-photo" title="Clique para alterar foto" tabindex="0"
                    role="button" aria-label="Alterar foto do perfil">
                    <img id="photo-preview" src="https://via.placeholder.com/140" alt="Foto do usuário"
                        style="border-radius: 50%; width: 140px; height: 140px; object-fit: cover;" />
                </label>
            </div>
            <input type="file" id="upload-photo" style="display:none" accept="image/*" />

            <div class="profile-name">
                <span id="name-display">João Silva</span>
                <input type="text" id="name-input" value="João Silva" />
                <span class="edit-btn" id="edit-name-btn" title="Editar nome" role="button" tabindex="0">✏️</span>
            </div>

            <div class="profile-description">
                Profissional de construção civil
            </div>

            <div class="profile-location">
                São Paulo - SP<br />
                Bairro: Vila Mariana
            </div>

            <div class="followers-info">
                Seguidores: <strong id="followers-count">120</strong>
            </div>
        </div>
    </main>

    <script>

        // Função para carregar dados do sessionStorage e preencher a página
        function carregarPerfil() {
            const nomeUsuario = sessionStorage.NOME_USUARIO || 'Usuário';
            const enderecosUsuario = JSON.parse(sessionStorage.getItem('ENDERECOS_USUARIO')) || [];

            const nameDisplay = document.getElementById('name-display');
            const nameInput = document.getElementById('name-input');
            const locElem = document.querySelector('.profile-location');

            nameDisplay.textContent = nomeUsuario;
            nameInput.value = nomeUsuario;

            if (enderecosUsuario.length > 0) {
                const endereco = enderecosUsuario[0];
                locElem.innerHTML = `${endereco.cidade} - ${endereco.uf}<br />Bairro: ${endereco.bairro}`;
            } else {
                locElem.textContent = 'Localização não informada';
            }
        }

        // Evento para editar nome
        const editBtn = document.getElementById('edit-name-btn');
        const nameDisplay = document.getElementById('name-display');
        const nameInput = document.getElementById('name-input');

        editBtn.addEventListener('click', () => {
            nameDisplay.style.display = 'none';
            nameInput.style.display = 'inline-block';
            nameInput.focus();
            editBtn.style.display = 'none';
        });

        nameInput.addEventListener('blur', () => {
            const novoNome = nameInput.value.trim();
            if (novoNome !== '') {
                nameDisplay.textContent = novoNome;
                sessionStorage.NOME_USUARIO = novoNome; // atualiza sessionStorage
            }
            nameDisplay.style.display = 'inline-block';
            nameInput.style.display = 'none';
            editBtn.style.display = 'inline-block';
        });

        // Inicializa a página carregando os dados
        window.addEventListener('DOMContentLoaded', carregarPerfil);

        const photoPreview = document.getElementById('photo-preview');
        const uploadInput = document.getElementById('upload-photo');

        function carregarFotoPerfil() {
            const fotoSalva = sessionStorage.FOTO_USUARIO;
            if (fotoSalva) {
                photoPreview.src = fotoSalva;
            }
        }

        // Ao trocar a foto
        uploadInput.addEventListener('change', () => {
            const file = uploadInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    photoPreview.src = e.target.result;
                    sessionStorage.FOTO_USUARIO = e.target.result; // salva a imagem em base64 na sessão
                };
                reader.readAsDataURL(file);
            }
        });

        window.addEventListener('DOMContentLoaded', () => {
            carregarFotoPerfil();
        });

        async function atualizarSeguidores() {
            const userId = sessionStorage.ID_USUARIO;
            if (!userId) return;

            try {
                const response = await fetch(`/usuario/seguidores/count/${sessionStorage.ID_USUARIO}`);
                if (!response.ok) throw new Error('Erro ao buscar seguidores');

                const data = await response.json();
                document.getElementById('followers-count').textContent = data.count || 0;
            } catch (error) {
                console.error(error);
                document.getElementById('followers-count').textContent = 0;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            atualizarSeguidores();
        });




    </script>
</body>

</html>