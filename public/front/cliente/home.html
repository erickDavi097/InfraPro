<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Publica칞칫es</title>
    <link rel="stylesheet" href="../../css/publicacao.css" />
    <style>
        .ver-mais {
            color: blue;
            cursor: pointer;
            display: inline-block;
            margin-top: 5px;
        }
    </style>
</head>

<body onload="carregarPublicacoes()">
    <div class="container">
        <button id="toggleDarkMode">Ativar Dark Mode</button>
        <h1>Publica칞칫es Recentes</h1>
        <div id="containerPublicacoes"></div>
    </div>

    <div id="modalComentarios" class="modal" style="display: none;">
        <div class="modal-conteudo">
            <span id="fecharModal" class="fechar">&times;</span>
            <h2>Coment치rios</h2>
            <ul id="listaComentariosModal"></ul>
            <div id="inputComentarioModal">
                <input type="text" id="inputTextoComentarioModal" placeholder="Escreva um coment치rio..." />
                <button id="btnEnviarComentarioModal">Enviar</button>
            </div>
        </div>
    </div>

    <div id="modalCurtidas" class="modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
        <div class="modal-conteudo"
            style="background:#fff; padding:20px; border-radius:8px; max-width:400px; max-height:80vh; overflow-y:auto;">
            <span id="fecharModalCurtidas" class="fechar"
                style="cursor:pointer; float:right; font-size:20px;">&times;</span>
            <h2>Curtidas</h2>
            <ul id="listaCurtidas"></ul>
        </div>
    </div>

    <script>
        const btn = document.getElementById('toggleDarkMode');

        function setDarkMode(enabled) {
            if (enabled) {
                document.body.classList.add('dark-mode');
                btn.textContent = 'Desativar Dark Mode';
                localStorage.setItem('darkMode', 'enabled');
            } else {
                document.body.classList.remove('dark-mode');
                btn.textContent = 'Ativar Dark Mode';
                localStorage.setItem('darkMode', 'disabled');
            }
        }

        const savedMode = localStorage.getItem('darkMode');
        if (savedMode === 'enabled') {
            setDarkMode(true);
        } else {
            setDarkMode(false);
        }

        btn.addEventListener('click', function () {
            const isDark = document.body.classList.contains('dark-mode');
            setDarkMode(!isDark);
        });

        function formatarDataOuTempo(dataPublicacao) {
            const agora = new Date();
            const publicado = new Date(dataPublicacao);
            const diffMs = agora - publicado;
            const diffHoras = diffMs / (1000 * 60 * 60);

            if (diffHoras < 24) {
                const segundos = Math.floor(diffMs / 1000);
                const minutos = Math.floor(segundos / 60);
                const horas = Math.floor(minutos / 60);

                if (horas > 0) {
                    if (horas === 1) {
                        return 'Publicado h치 1 hora';
                    } else {
                        return 'Publicado h치 ' + horas + ' horas';
                    }
                }
                if (minutos > 0) {
                    if (minutos === 1) {
                        return 'Publicado h치 1 minuto';
                    } else {
                        return 'Publicado h치 ' + minutos + ' minutos';
                    }
                }
                if (segundos === 1) {
                    return 'Publicado h치 1 segundo';
                } else {
                    return 'Publicado h치 ' + segundos + ' segundos';
                }
            } else {
                return 'Publicado em: ' + publicado.toLocaleDateString('pt-BR');
            }
        }

        function carregarPublicacoes() {
            fetch('/publicacoes')
                .then(function (res) { return res.json(); })
                .then(function (publicacoes) {
                    if (!publicacoes) return;
                    const container = document.getElementById('containerPublicacoes');
                    container.innerHTML = '';

                    for (let i = 0; i < publicacoes.length; i++) {
                        const pub = publicacoes[i];
                        const card = document.createElement('div');
                        card.classList.add('card-publicacao');

                        const conteudoCompleto = pub.conteudo;
                        const limite = 75;
                        let conteudoExibido = '';
                        if (conteudoCompleto.length > limite) {
                            conteudoExibido = conteudoCompleto.substring(0, limite) + '...';
                        } else {
                            conteudoExibido = conteudoCompleto;
                        }

                        let verMaisHTML = '';
                        if (conteudoCompleto.length > limite) {
                            verMaisHTML = '<span class="ver-mais">Ver mais</span>';
                        }

                        card.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <a href="../../PerfilPublico.html?id=${pub.usuarioId}">
                                        <img src="../../uploads/${pub.foto}" alt="Foto do usu치rio" 
                                            style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                                    </a>
                                    <a href="../../PerfilPublico.html?id=${pub.usuarioId}" 
                                    style="text-decoration: none; color: inherit;">
                                        <p style="margin: 0; font-weight: bold;">${pub.usuarioNome}</p>
                                    </a>
                                </div>
                                <button class="btn-seguir">Seguir</button>
                            </div>

                            <div>
                                <img src="../../assets/${pub.imagem}" alt="Imagem da publica칞칚o" 
                                    style="width: 100%; border-radius: 10px; margin-bottom: 10px;">
                            </div>

                            <h3 style="margin: 0 0 8px 0;">${pub.titulo}</h3>

                            <div class="interacoes" style="margin-bottom: 8px;">
                                <span class="icone-curtir" style="cursor: default;">仇벒잺</span> 
                                <span class="contador-curtidas" style="cursor: pointer;"></span> 
                                <span class="icone-comentario" style="cursor: pointer;">游눫</span>
                            </div>

                            <p class="descricao" style="margin-bottom: 8px;">${conteudoExibido}${verMaisHTML}</p>
                            

                            <p><strong>Servi칞o:</strong> ${pub.servicoNome}</p>
                            <p><strong>Valor base:</strong> R$ ${pub.valorBase}</p>
                            <p><em>${formatarDataOuTempo(pub.dtCriacao)}</em></p>

                            <div class="comentarios" style="display: none; margin-top: 10px;">
                                <ul class="lista-comentarios"></ul>
                                <div class="input-area" style="display: flex; gap: 5px; margin-top: 5px;">
                                    <input type="text" class="input-comentario" placeholder="Escreva um coment치rio..." 
                                        style="flex: 1; padding: 5px;">
                                    <span class="icone-enviar" style="cursor: pointer;">俱뫮잺</span>
                                </div>
                            </div>
                        `;


                        container.appendChild(card);

                        const descricao = card.querySelector('.descricao');
                        const verMais = card.querySelector('.ver-mais');

                        if (verMais) {
                            let expandido = false;
                            verMais.addEventListener('click', function () {
                                expandido = !expandido;
                                if (expandido) {
                                    descricao.innerHTML = conteudoCompleto + ' ';
                                    verMais.textContent = 'Ver menos';
                                } else {
                                    descricao.innerHTML = conteudoExibido + ' ';
                                    verMais.textContent = 'Ver mais';
                                }
                                descricao.appendChild(verMais);

                            });
                        }

                        const idPublicacao = pub.id;
                        const fkUsuario = sessionStorage.getItem('ID_USUARIO');

                        const iconeCurtir = card.querySelector('.icone-curtir');
                        const contadorCurtidas = card.querySelector('.contador-curtidas');

                        function atualizarCurtidas() {
                            fetch('/curtida/publicacao/' + idPublicacao)
                                .then(function (res) { return res.json(); })
                                .then(function (data) {
                                    contadorCurtidas.textContent = data.totalCurtidas;
                                });
                        }

                        iconeCurtir.addEventListener('click', function () {
                            fetch('/curtida/verificar/' + fkUsuario + '/' + idPublicacao)
                                .then(function (res) { return res.json(); })
                                .then(function (jacurtiu) {
                                    let url = '';
                                    let method = '';
                                    if (jacurtiu) {
                                        url = '/curtida/descurtir';
                                        method = 'DELETE';
                                    } else {
                                        url = '/curtida/curtir';
                                        method = 'POST';
                                    }
                                    fetch(url, {
                                        method: method,
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ fkUsuario: fkUsuario, fkPublicacao: idPublicacao })
                                    }).then(function () {
                                        atualizarCurtidas();
                                    });
                                });
                        });

                        atualizarCurtidas();

                        const iconeComentario = card.querySelector('.icone-comentario');
                        iconeComentario.addEventListener('click', function () {
                            abrirModalComentarios(idPublicacao);
                        });

                        const btnSeguir = card.querySelector('.btn-seguir');
                        btnSeguir.addEventListener('click', function () {
                            alert('Voc칡 clicou em seguir o usu치rio ' + pub.usuarioNome);
                        });
                    }
                });
        }

        function abrirModalComentarios(idPublicacao) {
            const modal = document.getElementById('modalComentarios');
            const listaComentariosModal = document.getElementById('listaComentariosModal');
            modal.style.display = 'flex';
            listaComentariosModal.innerHTML = '<li>Carregando coment치rios...</li>';

            fetch('/comentario/detalhes/' + idPublicacao)
                .then(function (res) { return res.json(); })
                .then(function (comentarios) {
                    listaComentariosModal.innerHTML = '';
                    if (comentarios.length === 0) {
                        listaComentariosModal.innerHTML = '<li>Nenhum coment치rio ainda.</li>';
                        return;
                    }
                    for (let i = 0; i < comentarios.length; i++) {
                        const coment = comentarios[i];
                        const li = document.createElement('li');
                        li.textContent = coment.usuarioNome + ': ' + coment.conteudo;
                        listaComentariosModal.appendChild(li);
                    }
                });
        }

        document.getElementById('fecharModal').addEventListener('click', function () {
            document.getElementById('modalComentarios').style.display = 'none';
        });

        const modalCurtidas = document.getElementById('modalCurtidas');
        const fecharModalCurtidasBtn = document.getElementById('fecharModalCurtidas');
        const listaCurtidas = document.getElementById('listaCurtidas');

        fecharModalCurtidasBtn.addEventListener('click', function () {
            modalCurtidas.style.display = 'none';
            listaCurtidas.innerHTML = '';
        });

        function abrirModalCurtidas(idPublicacao) {
            listaCurtidas.innerHTML = '<li>Carregando curtidas...</li>';
            modalCurtidas.style.display = 'flex';

            fetch('/curtida/lista/' + idPublicacao)
                .then(function (res) { return res.json(); })
                .then(function (data) {
                    listaCurtidas.innerHTML = '';
                    if (data.length === 0) {
                        listaCurtidas.innerHTML = '<li>Nenhuma curtida ainda.</li>';
                        return;
                    }
                    for (let i = 0; i < data.length; i++) {
                        const user = data[i];
                        const li = document.createElement('li');
                        li.textContent = user.nomeUsuario;
                        listaCurtidas.appendChild(li);
                    }
                });
        }
    </script>
</body>

</html>