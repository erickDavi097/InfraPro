<!DOCTYPE html>
<html>

<head>
    <title>Perfil do Usuário</title>
    <link rel="stylesheet" href="css/perfil.css" />
    <link rel="shortcut icon" href="./assets/icon/logo.png" type="image/x-icon">
</head>

<body>
    <div class="container">

        <nav class="sidebar">
            <a href="#">
                <h2>InfraPro</h2>
            </a>
            <a href="./front/cliente/home.html">Home</a>
            <a href="#">Chat</a>
            <a href="#">Perfil</a>
            <a href="#">Configurações</a>
        </nav>

        <div class="content">
            <div>
                <label for="upload-photo" class="profile-photo" title="Clique para alterar foto" tabindex="0"
                    role="button" aria-label="Alterar foto do perfil">
                    <img id="photo-preview" src="/public/assets/imgs/userCli.png" alt="Foto do usuário"
                        style="border-radius: 50%; width: 140px; height: 140px; object-fit: cover;" />
                </label>
            </div>

            <input type="file" id="upload-photo" style="display:none" accept="image/*" />

            <div class="profile-name">
                <span id="name-display">João Silva</span>
                <input type="text" id="name-input" value="João Silva" />
            </div>

            <div class="profile-description">
                Profissional de construção civil
            </div>

            <div class="profile-location">
                São Paulo - SP<br />
                Bairro: Vila Mariana
            </div>

            <div class="followers-info">
                Seguidores: <strong id="followers-count">120</strong>
            </div>
        </div>
    </div>

    <script>
        function carregarPerfil() {
            const nomeUsuario = sessionStorage.NOME_USUARIO || 'Usuário';
            const enderecosUsuario = JSON.parse(sessionStorage.getItem('ENDERECOS_USUARIO')) || [];

            const nameDisplay = document.getElementById('name-display');
            const nameInput = document.getElementById('name-input');
            const locElem = document.querySelector('.profile-location');

            nameDisplay.textContent = nomeUsuario;
            nameInput.value = nomeUsuario;

            if (enderecosUsuario.length > 0) {
                const endereco = enderecosUsuario[0];
                locElem.innerHTML = `${endereco.cidade} - ${endereco.uf}<br />Bairro: ${endereco.bairro}`;
            } else {
                locElem.textContent = 'Localização não informada';
            }
        }

        async function carregarFotoPerfil() {
            const userId = sessionStorage.ID_USUARIO;
            if (!userId) {
                photoPreview.src = '/public/assets/imgs/userCli.png';
                return;
            }

            try {
                const response = await fetch(`/usuario/foto/${userId}`);

                if (!response.ok) throw new Error('Erro ao buscar a foto');

                const data = await response.json();

                if (data.foto && data.foto.trim() !== '') {
                    photoPreview.src = `${data.foto}`;
                } else {
                    photoPreview.src = '/public/assets/imgs/userCli.png';
                }
            } catch (error) {
                console.error(error);
                photoPreview.src = '/public/assets/imgs/userCli.png';
            }
        }



        async function atualizarSeguidores() {
            const userId = sessionStorage.ID_USUARIO;
            if (!userId) return;

            try {
                const response = await fetch(`/usuario/seguidores/count/${userId}`);
                if (!response.ok) throw new Error('Erro ao buscar seguidores');

                const data = await response.json();
                document.getElementById('followers-count').textContent = data.count || 0;
            } catch (error) {
                console.error(error);
                document.getElementById('followers-count').textContent = 0;
            }
        }

        const photoPreview = document.getElementById('photo-preview');
        const uploadInput = document.getElementById('upload-photo');

        uploadInput.addEventListener('change', async () => {
            const file = uploadInput.files[0];
            const userId = sessionStorage.ID_USUARIO;

            if (file && userId) {
                const formData = new FormData();
                formData.append('foto', file);

                try {
                    const response = await fetch(`/usuario/uploadFoto/${userId}`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            photoPreview.src = e.target.result;
                            sessionStorage.FOTO_USUARIO = e.target.result;
                        };
                        reader.readAsDataURL(file);

                        alert('Foto atualizada com sucesso!');
                    } else {
                        alert('Erro ao atualizar a foto.');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao enviar a foto.');
                }
            }
        });

        window.onload = function () {
            carregarPerfil();
            carregarFotoPerfil();
            atualizarSeguidores();
        };
    </script>
</body>

</html>